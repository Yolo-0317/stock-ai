# 📋 AI 详细分析日志说明

## 🎯 功能说明

监控脚本现在支持**在日志文件中记录 AI 的完整详细分析**，而保持**控制台和飞书通知的简洁性**。

### 三层输出

| 输出位置 | 内容 | 详细程度 |
|---------|------|----------|
| **控制台** | 简洁的操作信号 | ⭐ 最简洁 |
| **日志文件** | 完整的 AI 分析 | ⭐⭐⭐ 最详细 |
| **飞书通知** | 简洁的操作信号 | ⭐ 最简洁 |

---

## ⚙️ 配置

在 `monitor_intraday_signals.py` 的 `main()` 函数中：

```python
# 做T专用配置
use_t_signal = True              # 使用做T信号
log_ai_detail = True             # ⭐ 在日志文件中记录AI完整分析
```

### 配置选项

- `log_ai_detail = True`：日志文件记录**完整的 AI 分析**（包括日内趋势、量价配合、关键位置等）
- `log_ai_detail = False`：日志文件只记录**简洁的信号**

---

## 📊 输出对比

### 控制台输出（简洁）

```
==================================================
⏰ 18:10:35  |  159218
==================================================
🔴 卖出  【立即卖出】
──────────────────────────────────────────────────
💰 执行价格: 1.625
📊 建议数量: 50.0%
🛡️ 止损价格: 1.640
🎯 目标价格: 1.510
──────────────────────────────────────────────────
💡 原因: 价格已大幅偏离均线，日内冲高后高位滞涨
==================================================
```

### 日志文件输出（详细，格式已优化）

```
2025-12-26 18:10:35 - INFO - 
==================================================
⏰ 18:10:35  |  159218
==================================================
🔴 卖出  【立即卖出】
──────────────────────────────────────────────────
💰 执行价格: 1.625
📊 建议数量: 50.0%
🛡️ 止损价格: 1.640
🎯 目标价格: 1.510
──────────────────────────────────────────────────
💡 原因: 价格已大幅偏离均线，日内冲高后高位滞涨
==================================================

2025-12-26 18:10:35 - INFO - 

### 🔴 AI 操作指令: 159218
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📊 **当前行情** (2025-12-26)
   当前价: 1.625  |  涨跌: 3.64%
   日内区间: 1.555 ~ 1.637 (当前位于 85% 位置)
   技术指标: MA5=1.5114, MA20=1.3730
- **持仓成本**: 1.55 (浮动盈亏: +4.84%)
- **当前仓位**: 50.0%
- **日内分析**: 已参考 21 条分钟数据

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🎯 **操作指令**: 立即卖出

📍 执行价格: 1.625
📊 建议数量: 50.0%
🛡️ 止损价格: 1.640
🎁 目标价格: 1.510

💡 核心原因: 价格已大幅偏离均线，日内冲高后高位滞涨

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📋 **AI 完整分析**：

日内趋势分析: 从分钟线数据看，今日价格大幅高开并持续上涨，
当前价1.625已接近日内最高点1.637，日内位置高达85.4%，
显示为单边强势上涨行情，无回调震荡。

量价配合: 成交量在拉升过程中逐步放大，显示多头力量强劲，
但在高位成交量开始萎缩，可能出现上攻乏力。

关键位置: 当前价格已远离MA5（1.511）和MA20（1.373），
短期涨幅巨大。日内高点1.637构成直接压力，下方支撑可参考
MA5（1.511）及今日开盘价1.568。

操作指令: 立即卖出
执行价格: 1.625
建议数量: 50.0%
止损价格: 1.640
目标价格: 1.510
核心原因: 价格已大幅偏离均线，日内冲高后高位滞涨

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### 飞书通知（简洁）

```
==================================================
⏰ 18:10:35  |  159218
==================================================
🔴 卖出  【立即卖出】
──────────────────────────────────────────────────
💰 执行价格: 1.625
📊 建议数量: 50.0%
🛡️ 止损价格: 1.640
🎯 目标价格: 1.510
──────────────────────────────────────────────────
💡 原因: 价格已大幅偏离均线，日内冲高后高位滞涨
==================================================
```

---

## 📂 查看详细日志

### 查看今天的完整日志

```bash
cd /Users/huan.yu/dev/demo/stock/tushare-mcp

# 查看完整日志（包含AI详细分析）
cat logs/monitor_$(date +%Y%m%d).log
```

### 只看 AI 详细分析

```bash
# 提取 AI 完整分析部分
grep -A 20 "AI 完整分析" logs/monitor_$(date +%Y%m%d).log
```

### 实时查看

```bash
# 实时查看日志文件
tail -f logs/monitor_$(date +%Y%m%d).log
```

---

## 💡 使用场景

### 场景 1：盘中快速决策

**看控制台**：只看简洁的信号，快速决策
- ✅ 操作指令：立即卖出
- ✅ 执行价格：1.625
- ✅ 建议数量：50%

### 场景 2：盘后复盘分析

**看日志文件**：查看完整的 AI 分析，了解决策依据
- ✅ 日内趋势分析：如何运行的？
- ✅ 量价配合：成交量变化如何？
- ✅ 关键位置：支撑/压力在哪里？

### 场景 3：移动端接收通知

**飞书通知**：手机上收到简洁的通知，不会被长文刷屏
- ✅ 重点突出
- ✅ 易于阅读

---

## 🎨 格式优化

为了让日志文件更易读，系统会自动清理 AI 报告的格式：

### 优化项目

1. **移除多余缩进**：去掉每行开头的多余空格
2. **统一格式**：移除 `- **字段**:` 开头的 `- ` 前缀
3. **保持结构**：保留内容完整性和层次结构

### 格式对比

**优化前（有多余缩进）**：
```
        ### ⚪ AI 操作指令: 159840
        ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
- **持仓成本**: 0.869
```

**优化后（干净整洁）**：
```
### ⚪ AI 操作指令: 159840
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
**持仓成本**: 0.869
```

---

## 🔧 技术实现

### 1. 控制台输出

使用 `logger.info(msg)` 输出简洁信号，同时输出到控制台和日志文件。

### 2. 详细分析记录

使用 `FileHandler.emit()` 直接向日志文件写入完整的 report，**不输出到控制台**：

```python
if log_ai_detail and use_t_signal and enable_deepseek:
    for handler in logger.handlers:
        if isinstance(handler, logging.FileHandler):
            record = logging.LogRecord(...)
            handler.emit(record)  # 只输出到文件
```

### 3. 飞书通知

使用简洁的 `msg`，不包含详细分析：

```python
send_to_lark(msg, is_error=False)  # 只发送简洁信号
```

---

## 📚 相关配置

### 完整配置示例

```python
def main() -> int:
    codes = ["159218", "159840"]
    interval = 60.0
    all_day = True
    enable_feishu = True
    enable_deepseek = True
    
    # 做T专用配置
    use_t_signal = True              # 使用做T信号
    print_all_signals = True         # 打印所有信号
    log_ai_detail = True             # ⭐ 记录AI详细分析到日志
    
    position_costs = {
        "159218": 1.197,
        "159840": 0.869,
    }
    position_ratios = {
        "159218": 0.2374,
        "159840": 0.1058,
    }
    # ...
```

---

## ⚠️ 注意事项

1. **日志文件会变大**：启用 `log_ai_detail` 后，日志文件会包含完整的 AI 分析，文件大小会增加
2. **定期清理**：建议定期清理旧日志文件
3. **磁盘空间**：确保有足够的磁盘空间存储日志

### 清理建议

```bash
# 删除30天前的日志
find logs/ -name "monitor_*.log" -mtime +30 -delete

# 压缩旧日志
gzip logs/monitor_202512*.log
```

---

## 📖 相关文档

- [LOGGING_GUIDE.md](./LOGGING_GUIDE.md) - 日志系统详细说明
- [README_LOGGER.md](./README_LOGGER.md) - 日志配置模块使用说明
- [CONFIG_GUIDE.md](./CONFIG_GUIDE.md) - 监控脚本配置指南

---

**现在你可以在日志文件中查看完整的 AI 分析，同时保持控制台和通知的简洁！** 📝

